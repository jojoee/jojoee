---
description: jojoee project context and conventions
globs:
alwaysApply: true
---

# jojoee Project

A FastAPI application that generates dynamic GitHub README content showing commit patterns and serves UTC time images/GIFs. See [README.md](../../README.md) for current output.

## Project Structure

```
jojoee/
├── app/
│   └── main.py          # FastAPI application endpoints
├── module/
│   ├── commit.py        # GitHub commit analysis logic
│   └── image.py         # Image/GIF generation utilities
├── tests/               # pytest tests (test_*.py)
├── precompute/          # Generated images/GIFs cache
│   ├── image/           # PNG cache
│   └── gif/             # GIF cache
├── event.py             # README generator script (entry point)
├── Dockerfile           # Container configuration
├── requirements.txt     # Production dependencies
└── requirements-dev.txt # Development dependencies
```

## Technology Stack

- Python 3.8+ with FastAPI
- pytest for testing, flake8 for linting
- PIL/Pillow for image generation
- imageio for GIF creation
- requests-cache for GitHub API caching
- Docker with uvicorn for deployment

## Python Conventions

- Use type hints for function parameters and return types: `def get_image_from_text(text: str) -> Image:`
- Use `Dict`, `List` from typing module: `from typing import List, Dict`
- Environment variables via `os.environ.get()`: `GITHUB_TOKEN = os.environ.get('GH_TOKEN')`
- Use docstrings with :param and :return: format for documentation
- Module-level constants in UPPER_CASE: `IMAGE_DIR_PATH`, `GIF_DIR_PATH`
- Use `.get()` for safe dictionary access: `event.get("type")` not `event["type"]`
- Use `isinstance()` to validate types before processing: `if not isinstance(data, list):`
- Use f-strings for URL construction: `f"https://api.github.com/repos/{repo}/compare/{sha1}...{sha2}"`

## Exit Code Conventions

- `sys.exit(1)` - Error occurred, fail CI pipeline (no commit)
- `sys.exit(0)` - Graceful exit, skip remaining steps (no commit)
- Normal completion - Success, proceed with commit

## FastAPI Conventions

- Route decorators use `@app.get("/path")` pattern
- Use `Request` and `Response` from fastapi for HTTP handling
- Return `StreamingResponse` for binary data (images/GIFs)
- Use `@repeat_every` decorator for scheduled tasks

## Testing Conventions

- Test files: `tests/test_*.py`
- Use pytest with class-based tests: `class TestRunner:`
- Test method names: `def test_<description>(self):`
- Run tests: `pytest tests/`

## Verification Steps

Before committing changes, run these verification steps:

1. **Syntax Check**: `python3 -m py_compile module/commit.py` - Verify no syntax errors
2. **Dryrun Test**: `python3 event.py --dryrun` - Test README generation without API calls
3. **Live Test**: `python3 event.py` - Test with real GitHub API calls
4. **Linting**: `flake8 .` - Check code quality (requires venv activation)
5. **Unit Tests**: `pytest tests/` - Verify all tests pass (requires venv activation)
6. **Local Server**: `uvicorn app.main:app --reload` - Test endpoints manually

## Local Development

1. Create virtual environment: `python -m venv venv`
2. Activate: `source venv/bin/activate`
3. Install dependencies: `pip install -r requirements.txt -r requirements-dev.txt`
4. Run server: `uvicorn app.main:app --reload --port 8000`

## Docker

Build and run:
```bash
docker build -t jojoee .
docker run -p 8000:8000 jojoee
```

## GitHub API Conventions

- Always validate API response type before iterating: `if not isinstance(events, list): sys.exit(1)`
- Use Compare API for commit details (Events API omits `commits` array): `/repos/{owner}/{repo}/compare/{before}...{head}`
- Add rate limiting between API calls: `time.sleep(0.2)`
- Use tuple auth: `requests.get(url, auth=(GITHUB_USER, GITHUB_TOKEN))`

## CI/CD Workflow

GitHub Actions runs daily at 1am UTC to:
1. Fetch latest GitHub commit data via `event.py`
2. Generate new README.md with commit statistics
3. Auto-commit changes to repository

Required secrets: `GH_USER`, `GH_TOKEN`, `GITHUB_TOKEN`

## API Endpoints

- `GET /` - Health check, returns `{"Hello": "World"}`
- `GET /api/utcnow` - Returns current UTC time as PNG image
- `GET /api/utcnowgif` - Returns current UTC time as animated GIF

## Post-Work

After implementing a feature:

1. **Update tests** - Add test cases in `tests/` folder
2. **Check linting** - Run `flake8 .` and fix issues
3. **Git commit** - Use semantic-release pattern (feat:, fix:, docs:, etc.)

## Known Issues

- **Broken venv**: The venv has incorrect interpreter paths. Recreate with:
  ```bash
  rm -rf venv
  python3 -m venv venv
  source venv/bin/activate
  pip install -r requirements.txt -r requirements-dev.txt
  ```
